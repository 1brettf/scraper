<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>linkFLTR</title>
	<meta name="viewport" content="width=device-width, initial-scale=1" />
        <style type="text/css" media="screen">
      BODY
      {
        font-family: helvetica, arial, sans-serif;
        font-size: 16px;
        margin: 0;
      }

      #header
      {
        background: linear-gradient(180deg, #0079FF 0%, #0068DB 100%);
        color: #fff;
        padding: 3px 6px;
        text-align: center;
        font-size: 18px;
        font-weight: bold;
      }

      .item
      {
        font-size: 14px;
        line-height: 18px;
        border-bottom: 1px solid #efefef;
        padding: 10px 20px;
        margin: 5px 0;
      }

      .source
      {
        font-weight: bold;
      }

      .date
      {
        color: #ccc;
        font-size: 14px;
        font-weight: normal;
      }

      a
      {
        color: #111;
      }

      a:visited
      {
        color: purple;
      }

      /* Navbar container */
.navbar {
  overflow: hidden;
  background-color: #333;
  font-family: Arial;
}

/* Links inside the navbar */
.navbar a {
  float: left;
  font-size: 16px;
  color: white;
  text-align: center;
  padding: 14px 16px;
  text-decoration: none;
}

/* The dropdown container */
.dropdown {
  float: left;
  overflow: hidden;
}

/* Dropdown button */
.dropdown .dropbtn {
  font-size: 16px;
  border: none;
  outline: none;
  color: white;
  padding: 14px 16px;
  background-color: inherit;
  font-family: inherit;
  margin: 0; /* Important for vertical align on mobile phones */
}

/* Add a red background color to navbar links on hover */
.navbar a:hover, .dropdown:hover .dropbtn {
  background-color: red;
}

/* Dropdown content (hidden by default) */
.dropdown-content {
  display: none;
  position: absolute;
  background-color: #f9f9f9;
  min-width: 160px;
  box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
  z-index: 1;
}

/* Links inside the dropdown */
.dropdown-content a {
  float: none;
  color: black;
  padding: 12px 16px;
  text-decoration: none;
  display: block;
  text-align: left;
}

/* Add a grey background color to dropdown links on hover */
.dropdown-content a:hover {
  background-color: #ddd;
}

/* Show the dropdown menu on hover */
.dropdown:hover .dropdown-content {
  display: block;
}
    </style>
<div class="navbar">
    <a href="/">Latest News</a>
  <div class="dropdown">
    <button class="dropbtn">Navigation
      <i class="fa fa-caret-down"></i>
    </button>
    <div class="dropdown-content">
      <a href="/saved">Saved</a>
      <a href="/skipped">Skipped</a>
      <a href="/read">Read</a>
    </div>
  </div>
</div>
</head>
<body>
<div id="feed"></div>
<script>
// Obfuscate + Minify code for production?

function set_saved(url, saved) {
    let xhr = new XMLHttpRequest();
    xhr.open("POST", "/post", true);
    xhr.setRequestHeader('Content-Type', 'application/json; charset=UTF-8');
    xhr.send('{"request_type": "set_saved", "url_list": ' + JSON.stringify(saved) + '}');
    xhr.onloadend = function () {
        //location.reload();
        parse_feed(window.feed, window.my_data);
        print_feed();
    }
}

function set_skipped(url, skipped) {
    let xhr = new XMLHttpRequest();
    xhr.open("POST", "/post", true);
    xhr.setRequestHeader('Content-Type', 'application/json; charset=UTF-8');
    xhr.send('{"request_type": "set_skipped", "url_list": ' + JSON.stringify(skipped) + '}');
}

function set_read(url, read) {
    let xhr = new XMLHttpRequest();
    xhr.open("POST", "/post", true);
    xhr.setRequestHeader('Content-Type', 'application/json; charset=UTF-8');
    xhr.send('{"request_type": "set_read", "url_list": ' + JSON.stringify(read) + '}');
    xhr.onloadend = function () {
        //window.location.href = url;  //maybe offer setting to change between?
        window.open(url, "_blank");
    }
}

//function set_tags(url, tags) {
//    let tag_xhr = new XMLHttpRequest();
//    tag_xhr.open("POST", "/post", true);
//    tag_xhr.setRequestHeader('Content-Type', 'application/json; charset=UTF-8');
//    tag_xhr.send('{"request_type": "set_tags", "tags": ' + JSON.stringify(tags) + '}');
//}


function add_url_dict(url){
    for (let j = 0, size = window.feed.length; j < size; j++) {
        let sanitised_obj = window.feed[j];
        if (sanitised_obj.link === url) {
            window.my_data.url_dict[url] = {"source": sanitised_obj.source, "published": sanitised_obj.published, "title": sanitised_obj.title};
        }
    }
}




function send_read(url, remove) {
    let read = window.my_data["read"];
    if (remove) {
            read = remove_element(read, url);
    }
    else if (!read.indexOf(url) > -1) {
            read.push(url);
            add_url_dict(url);
    }
    window.my_data["read"] = read;
    set_read(url, read);
}

function send_saved(url, remove) {
    let saved = window.my_data["saved"];
    if (remove) {
            saved = remove_element(saved, url);
    }
    else if (!saved.indexOf(url) > -1) { //!saved.indexOf(url) > -1  //!saved.includes(url)
            saved.push(url);
            add_url_dict(url);
    }
    window.my_data["saved"] = saved;
    parse_feed(window.feed, window.my_data);
    print_feed();
    set_saved(url, saved);
}

function send_skipped(url, remove) {
    let skipped = window.my_data["skipped"];
    if (remove) {
            skipped = remove_element(skipped, url);
    }
    else if (!skipped.indexOf(url) > -1) {
            skipped.push(url);
            add_url_dict(url);
    }
    window.my_data["skipped"] = skipped;
    parse_feed(window.feed, window.my_data);
    print_feed();
    set_skipped(url, skipped);
}


//function send_tag(url, tag, remove) {
    //window.my_data;

//}

function remove_element(my_list, element) {
  my_list.splice(my_list.indexOf(element), 1);
  return my_list
}

function print_feed() {
    document.getElementById("feed").innerHTML = "";
    for (let j = 0, size = window.feed.length; j < size; j++) {
        let sanitised_obj = window.feed[j];
        if ((sanitised_obj.skipped !== true) && (sanitised_obj.saved !== true)) {
            document.getElementById("feed").innerHTML = document.getElementById("feed").innerHTML +
                            "<div class='item'><div class='source'>" + sanitised_obj.source + "<span class='date'> " + sanitised_obj.published + "</div><div class='story'><a href='#' onclick='send_read(\"" + sanitised_obj.link + "\", false)'>" + sanitised_obj.title + "</a></div><div class='actions'><a href='#' onclick='send_skipped(\"" + sanitised_obj.link + "\", false)'>Skip</a> <a href='#' onclick='send_saved(\"" + sanitised_obj.link + "\", false)'>Save</a></div></div>";
        }
    }
}

function parse_feed(my_feed, my_data){
    let sanitised_feed = []
    for (let i = 0, size = my_feed.length; i < size; i++) {
        let feed_item = my_feed[i];
        //!saved.indexOf(url) > -1
        feed_item["skipped"] = my_data["skipped"].indexOf(feed_item["link"]) > -1;
        feed_item["saved"] = my_data["saved"].indexOf(feed_item["link"]) > -1;
        feed_item["read"] = my_data["read"].indexOf(feed_item["read"]) > -1;
        if (feed_item["link"] in my_data["tags"]) {
            feed_item["tags"] = my_data["tags"][feed_item["link"]];
        } else {
            feed_item["tags"] = [];
        }
        sanitised_feed.push(feed_item);
    }
    window.feed = sanitised_feed;
    window.my_data = my_data;
}

function show_feed() {
    let xhr = new XMLHttpRequest();
    xhr.open("POST", "/post", true);
    xhr.setRequestHeader('Content-Type', 'application/json; charset=UTF-8');
    xhr.onloadend = function () {
        let my_data = JSON.parse(xhr.responseText);
        let xhr2 = new XMLHttpRequest();
        xhr2.open("POST", "/post", true);
        xhr2.setRequestHeader('Content-Type', 'application/json; charset=UTF-8');
        xhr2.onloadend = function () {
            let my_feed = JSON.parse(xhr2.responseText);
            parse_feed(my_feed, my_data);
            print_feed();
        };
        xhr2.send('{"request_type": "feed"}');
    };
    xhr.send('{"request_type": "get_info"}');
}

show_feed();
</script>
</body>
</html>